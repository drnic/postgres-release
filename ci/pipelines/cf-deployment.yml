resources:
- name: cf-deployment
  type: git
  source:
    uri: https://github.com/cloudfoundry/cf-deployment.git
    branch: release-candidate

- name: postgres-release-develop
  type: git
  source:
    uri: https://github.com/cloudfoundry/postgres-release.git
    branch: develop

- name: postgres-ci-env
  type: git
  source:
    uri: git@github.com:cloudfoundry/postgres-ci-env
    branch: master
    private_key: {{postgres_ci_env_private_key}}

- name: cf-acceptance-tests
  type: git
  source:
    uri: https://github.com/cloudfoundry/cf-acceptance-tests.git
    branch: master

jobs:
- name: upload-stemcells-releases
  serial_groups: [cf-fresh,cf-old,cf-older]
  plan:
  - aggregate:
    - get: postgres-release
      resource: postgres-release-develop
  - task: upload-stemcell-fresh
    file: postgres-release/ci/scripts/upload-stemcell/task.yml
    params: &bosh_params_fresh
      BOSH_DIRECTOR: {{fresh_bosh_director}}
      BOSH_CLIENT: {{fresh_bosh_user}}
      BOSH_CLIENT_SECRET: {{fresh_bosh_password}}
      BOSH_CA_CERT: {{fresh_ca_cert}}
      BOSH_PUBLIC_IP: {{fresh_bosh_public_ip}}
      STEMCELL_VERSION: {{stemcell_version}}
  - task: upload-stemcell-old
    file: postgres-release/ci/scripts/upload-stemcell/task.yml
    params: &bosh_params_old
      BOSH_DIRECTOR: {{old_bosh_director}}
      BOSH_CLIENT: {{old_bosh_user}}
      BOSH_CLIENT_SECRET: {{old_bosh_password}}
      BOSH_CA_CERT: {{old_ca_cert}}
      BOSH_PUBLIC_IP: {{old_bosh_public_ip}}
      STEMCELL_VERSION: {{stemcell_version}}
  - task: upload-stemcell-older
    file: postgres-release/ci/scripts/upload-stemcell/task.yml
    params: &bosh_params_older
      BOSH_DIRECTOR: {{older_bosh_director}}
      BOSH_CLIENT: {{older_bosh_user}}
      BOSH_CLIENT_SECRET: {{older_bosh_password}}
      BOSH_CA_CERT: {{older_ca_cert}}
      BOSH_PUBLIC_IP: {{older_bosh_public_ip}}
      STEMCELL_VERSION: {{stemcell_version}}
  - task: create-postgres-dev-release-tarball
    file: postgres-release/ci/scripts/create-dev-release-tarball/task.yml
    input_mapping: {dev-release: postgres-release}
    output_mapping: {dev-release-tarball: postgres-tarball}
    params:
      <<: *bosh_params_fresh
      REL_NAME: postgres
      REL_VERSION: v999+dev.1
  - task: upload-postgres-dev-release-fresh
    file: postgres-release/ci/scripts/upload-dev-release-tarball/task.yml
    input_mapping: {dev-release-tarball: postgres-tarball}
    params:
      <<: *bosh_params_fresh
  - task: upload-postgres-dev-release-old
    file: postgres-release/ci/scripts/upload-dev-release-tarball/task.yml
    input_mapping: {dev-release-tarball: postgres-tarball}
    params:
      <<: *bosh_params_old
  - task: upload-postgres-dev-release-older
    file: postgres-release/ci/scripts/upload-dev-release-tarball/task.yml
    input_mapping: {dev-release-tarball: postgres-tarball}
    params:
      <<: *bosh_params_older

- name: test-fresh-deployment
  serial_groups: [cf-fresh]
  plan:
  - aggregate:
    - get: cf-deployment
    - get: postgres-ci-env
    - get: postgres-release
      resource: postgres-release-develop
      passed: [upload-stemcells-releases]
      trigger: true
  - task: deploy-cf
    file: postgres-release/ci/scripts/deploy-cf/task.yml
    params: &base_params_fresh
      <<: *bosh_params_fresh
      CF_DEPLOYMENT: {{fresh_cf_deployment}}
      API_PASSWORD: {{cf_api_password}}

- name: delete-deployments-fresh
  serial_groups: [cf-fresh]
  plan:
  - aggregate:
    - get: postgres-release
      resource: postgres-release-develop
      passed: [test-fresh-deployment]
      trigger: true
  - task: delete-cf-deployment
    file: postgres-release/ci/scripts/run-bosh-delete/task.yml
    params:
      <<: *bosh_params_fresh
      DEPLOYMENT_NAME: {{fresh_cf_deployment}}

- name: cleanup-releases
  serial_groups: [cf-fresh,cf-old,cf-older]
  plan:
  - aggregate:
    - get: postgres-release
      resource: postgres-release-develop
      passed: [delete-deployments-fresh,delete-deployments-old,delete-deployments-older]
      trigger: true
  - task: cleanup-releases-fresh
    file: postgres-release/ci/scripts/run-bosh-cleanup/task.yml
    params:
      <<: *bosh_params_fresh
  - task: cleanup-releases-old
    file: postgres-release/ci/scripts/run-bosh-cleanup/task.yml
    params:
      <<: *bosh_params_old
  - task: cleanup-releases-older
    file: postgres-release/ci/scripts/run-bosh-cleanup/task.yml
    params:
      <<: *bosh_params_older
